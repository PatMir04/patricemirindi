<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Uploads Demo (Enhanced, PatMir)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial,sans-serif; margin: 20px; background: #f5f7fa; }
    #summary, #debug { margin:12px 0 6px 0; font-size:0.95em; }
    .controls { display:flex; gap:14px; margin-bottom:10px; }
    label { font-weight:bold; }
    select, button { padding:2px 8px; }
    #debug { font-family:monospace; background:#f9fbe7; color:#333; padding:8px 12px; border-radius:6px;}
  </style>
</head>
<body>

  <h2>CSV Uploads Demo Dashboard <span id="loader" style="color:#1976d2;">Loading…</span></h2>
  <div id="summary"></div>
  <div class="controls">
    <label>Country:
      <select id="countrySel"><option>All</option></select>
    </label>
    <label>Indicator:
      <select id="indicatorSel"><option>All</option></select>
    </label>
    <label>Year:
      <select id="yearSel"><option>All</option></select>
    </label>
    <button id="refreshBtn">Show Chart</button>
  </div>
  <canvas id="demoChart" width="900" height="400"></canvas>
  <div id="debug"></div>

  <script>
    // CONFIG
    const GH_USER = 'PatMir04', GH_REPO = 'patricemirindi', GH_PATH = 'data/uploads';
    const RAW_ROOT = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/${GH_PATH}/`;
    const API_URL  = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`;

    let ALLDATA = [], chartObj = null, debugLog=[]; // Store logs for debug panel

    // LOGGING
    function dlog(...a){ debugLog.push(a.join(' ')); }
    function printDebug(){ document.getElementById('debug').textContent = debugLog.join('\n'); }

    // DATA LOADER
    async function loadAllCSVs() {
      document.getElementById('loader').textContent = "Loading CSV file list…";
      dlog('Fetching file list from GitHub API...');
      const resp = await fetch(API_URL);
      const files = (await resp.json()).filter(f=>f.name.endsWith('.csv'));
      let allRows = [];
      dlog(`Found ${files.length} CSV file(s).`);
      for (let f of files) {
        document.getElementById('loader').textContent = `Loading: ${f.name}…`;
        dlog(`Fetching ${f.name}...`);
        const txt = await fetch(RAW_ROOT + f.name).then(r=>r.text());
        const {data,errors} = Papa.parse(txt,{header:true,skipEmptyLines:true,transformHeader:h=>h.trim()});
        let clean = data.filter(row=>row.Country&&row.Year&&row.Indicator&&row.Value);
        dlog(`  Loaded ${data.length} rows, ${clean.length} valid (skipped: ${data.length - clean.length})`);
        if(errors&&errors.length){dlog('  PapaParse errors:',JSON.stringify(errors));}
        clean.forEach(r=>r.source=f.name);
        allRows.push(...clean);
      }
      // Remove regions/aggregates 
      const regionWords = ['Africa','Asia','Europe','Americas','Oceania','World','European Union','OECD'];
      const filtered = allRows.filter(r => !regionWords.some(region => String(r.Country).trim()===region));
      dlog(`After filtering regions/aggregates: ${filtered.length} records remain`);
      document.getElementById('loader').textContent = "";
      ALLDATA = filtered;
      printDebug();
    }

    // DROPDOWN POPULATORS
    function populateControls() {
      let C = Array.from(new Set(ALLDATA.map(r=>r.Country).filter(Boolean))).sort();
      let I = Array.from(new Set(ALLDATA.map(r=>r.Indicator).filter(Boolean))).sort();
      let Y = Array.from(new Set(ALLDATA.map(r=>r.Year).filter(Boolean))).sort((a,b)=>a-b);

      document.getElementById('countrySel').innerHTML = '<option value="">All</option>' + C.map(c=>`<option>${c}</option>`).join('');
      document.getElementById('indicatorSel').innerHTML = '<option value="">All</option>' + I.map(i=>`<option>${i}</option>`).join('');
      document.getElementById('yearSel').innerHTML = '<option value="">All</option>' + Y.map(y=>`<option>${y}</option>`).join('');
      document.getElementById('summary').innerHTML =
        `Loaded <b>${ALLDATA.length}</b> records from <b>${new Set(ALLDATA.map(r=>r.source||'csv')).size}</b> file(s). ` +
        `Countries: <b>${C.length}</b>, Indicators: <b>${I.length}</b>, Years: <b>${Y.length}</b>.`;
    }

    // FILTER
    function getFilteredData() {
      let c = document.getElementById('countrySel').value;
      let i = document.getElementById('indicatorSel').value;
      let y = document.getElementById('yearSel').value;
      return ALLDATA.filter(row =>
        (!c || row.Country===c) &&
        (!i || row.Indicator===i) &&
        (!y || row.Year==y)
      );
    }

    // CHART
    function showChart() {
      const c = document.getElementById('demoChart').getContext('2d');
      if (chartObj) chartObj.destroy();
      let rows = getFilteredData();
      if (!rows.length) { c.clearRect(0,0,900,400); return; }

      // By default: if one country & indicator, show Value by Year. 
      // If multiple countries, show each as series.
      const allYears = [...new Set(rows.map(r=>r.Year))].sort();
      const groups = {};
      rows.forEach(r=>{
        let key = r.Country || 'Data';
        if(!groups[key]) groups[key]=[];
        groups[key].push(r);
      });
      chartObj = new Chart(c, {
        type: 'line',
        data: {
          labels: allYears,
          datasets: Object.entries(groups).map(([key,rs],idx)=>({
            label: key,
            data: allYears.map(y=>{
              let found = rs.find(r=>String(r.Year)===String(y));
              return found ? Number(found.Value) : null;
            }),
            borderColor: ['#1976d2','#388e3c','#fbc02d','#d32f2f','#7b1fa2','#0097a7','#c2185b'][idx%7],
            fill:false,
            spanGaps:true,
          }))
        }
      });
    }

    // MAIN
    async function main() {
      debugLog = [];
      await loadAllCSVs();
      populateControls();
      showChart();
      dlog('Countries loaded:', new Set(ALLDATA.map(r=>r.Country)));
      dlog('Indicators loaded:', new Set(ALLDATA.map(r=>r.Indicator)));
      printDebug();
    }
    document.getElementById('refreshBtn').onclick = showChart;
    document.getElementById('countrySel').onchange = showChart;
    document.getElementById('indicatorSel').onchange = showChart;
    document.getElementById('yearSel').onchange = showChart;
    main();
  </script>
</body>
</html>
